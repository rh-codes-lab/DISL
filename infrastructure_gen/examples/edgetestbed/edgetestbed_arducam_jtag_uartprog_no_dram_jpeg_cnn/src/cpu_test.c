#include <stdarg.h> 
#include <stdint.h>
#include <stddef.h>
#include "utils.h"
#include "arducam_ov2640.h"
 
void quantize(int8_t* output);
void convolution2D(int8_t* input,int8_t* output);
void maxPooling2D(int8_t* input, int8_t* output);
void fullyConnected(int8_t* input, int8_t* output);

#define IMAGE_HEIGHT 240
#define IMAGE_WIDTH 40
#define IMAGE_CHANNELS 1
#define FILTER_HEIGHT 3
#define FILTER_WIDTH 3
#define FILTER_CHANNELS 1
#define CONV_STRIDE 1
#define POOL_SIZE 2
#define NUM_CLASSES 2

#define IMAGE_SIZE IMAGE_HEIGHT*IMAGE_WIDTH
#define CONV_OUTPUT_HEIGHT ((IMAGE_HEIGHT - FILTER_HEIGHT) / CONV_STRIDE + 1)
#define CONV_OUTPUT_WIDTH ((IMAGE_WIDTH - FILTER_WIDTH) / CONV_STRIDE + 1)
#define POOL_OUTPUT_HEIGHT (CONV_OUTPUT_HEIGHT / POOL_SIZE)
#define POOL_OUTPUT_WIDTH (CONV_OUTPUT_WIDTH / POOL_SIZE)
#define FC_PARAMETERS_PER_CLASS POOL_OUTPUT_HEIGHT*POOL_OUTPUT_WIDTH

const int8_t fc_weights[] = {4,-9,-87,29,-91,-52,-80,-75,-39,35,-112,-91,-25,-73,74,-80,-7,65,-25,-12,-43,80,15,48,-88,65,-87,-6,49,-51,79,-45,-99,36,68,7,23,24,-124,-42,-88,33,65,68,-6,47,-7,12,71,43,-1,-98,-66,16,63,14,5,-83,-98,-79,-42,-55,24,-81,-22,-5,72,69,70,18,46,-57,35,40,-30,63,23,-97,27,77,-81,29,-28,-41,-48,91,3,-68,10,-90,-24,-115,3,55,-1,27,-65,59,-39,-26,16,57,-83,-66,50,85,113,-7,60,32,-33,4,110,-68,-27,-58,-12,-80,5,-122,-95,31,11,-6,-73,11,24,64,-53,-26,-45,-8,-4,-53,42,-92,54,-82,-102,-7,79,16,35,-54,79,-34,-88,-13,-71,-2,-87,-109,-70,-96,-61,8,-78,-56,-94,53,-38,39,-12,12,-41,61,33,3,-25,55,62,-85,-55,78,-11,66,-71,3,61,-67,106,-40,-16,-19,-25,70,57,72,-70,4,-32,-24,-62,44,-27,-91,-83,-48,79,-4,-44,-55,-67,78,42,-41,41,21,-30,16,-67,-24,61,45,55,12,-57,-85,55,20,-67,80,-49,-32,-21,-84,-14,56,32,49,56,-50,-62,26,-26,-71,42,39,32,-17,55,23,-18,-44,83,-3,-9,-91,-75,-22,78,58,-20,-36,-62,-65,-88,-15,-40,98,18,-83,-6,-44,-24,-39,-58,-4,38,-59,23,-56,-16,38,-48,-40,43,96,-10,78,-59,23,-101,-3,-25,-80,-71,-78,61,-35,61,-63,-79,35,79,-61,-49,-37,92,61,0,81,-44,-47,-18,-50,-10,-47,14,0,-45,8,-81,-74,-23,-32,84,40,39,-37,69,-98,-107,-12,-56,55,15,-50,30,-11,-73,-21,5,42,-60,73,-29,19,32,-2,-35,-22,-63,16,74,64,-3,-25,107,51,58,-22,90,34,-42,-22,64,18,49,33,-52,-94,-8,-29,-52,58,28,-48,-6,-53,84,-45,41,84,-34,-66,-92,19,-32,99,10,-18,-38,48,-16,103,-12,-7,-31,68,1,-55,53,-68,83,3,-38,41,-74,27,62,59,3,-3,-46,100,81,78,-8,43,48,17,-26,-16,-50,-16,23,22,6,54,-77,4,73,62,-20,44,-22,-95,16,66,100,-11,-78,93,61,-104,65,54,-20,-24,80,11,37,81,71,26,-4,-54,24,-71,-50,-37,14,79,-85,-35,-85,65,-7,-32,-33,-6,46,56,-64,17,-7,-56,-2,70,78,-22,66,-14,-81,-50,-10,-45,61,-76,59,94,75,47,29,7,28,99,-56,17,20,86,1,66,2,-95,62,-76,-37,15,87,-52,-12,62,-32,34,-56,38,46,29,-29,-100,-1,-8,-22,-39,-27,61,-18,29,-56,11,-81,44,46,-15,-25,-60,50,-61,42,-30,15,16,43,-79,89,73,100,-51,-41,42,51,-51,6,87,-85,-66,-60,-53,-4,-68,-35,-10,-7,-8,-7,70,11,34,-25,35,-46,-91,-11,-50,-52,14,-40,10,-97,-54,-7,82,-39,96,-57,-4,-12,-47,-42,-77,48,-34,49,22,-78,36,-3,-62,52,-105,-52,-91,-25,4,52,31,-48,-35,55,-60,1,30,69,56,25,-1,27,-11,-3,24,68,-58,38,78,-90,96,-67,57,-38,-39,18,-4,-26,-86,-37,33,-38,-70,-99,-74,-52,-30,72,-18,68,-3,-16,56,-9,-61,-9,-62,18,17,58,-83,44,-23,-52,90,111,-84,43,24,-81,34,25,24,-11,48,26,-89,-32,-52,-15,-12,88,33,25,37,22,-80,77,94,-82,51,21,0,2,27,12,42,62,-68,-28,-51,-104,81,3,-60,-1,53,41,17,-27,-58,-47,33,14,-78,0,-29,47,-52,81,7,-47,-31,69,-72,-47,-33,38,-1,-94,53,47,79,25,4,38,-52,34,26,-86,70,-56,8,-82,-55,40,-40,33,49,-1,1,-6,32,-40,-60,72,91,-8,-42,89,86,-74,72,-83,-40,111,61,5,37,51,-21,-40,79,-62,-37,-63,11,29,-52,54,-55,71,-53,-67,-20,64,58,-43,-89,74,62,-80,87,-45,-58,-65,7,78,49,-42,-42,66,61,3,-7,62,-55,-76,46,15,30,-44,13,-6,79,39,76,13,68,4,3,-29,-50,113,24,92,-45,-11,-60,-58,24,-45,102,17,82,-63,71,-43,87,35,69,42,89,35,-66,-30,73,-26,-44,-2,-81,59,-19,59,6,49,2,-73,-45,-82,105,-87,80,83,-3,26,6,-18,27,-18,-73,86,102,-8,22,86,-101,-33,90,2,-44,-69,102,63,3,-29,62,-74,58,29,-27,-6,16,53,-38,-48,57,-63,-19,6,-57,49,18,-8,-49,-57,24,-74,-90,-19,89,62,99,-25,-24,48,-37,-19,-19,33,81,29,-30,-93,-6,-63,-59,-55,-17,-44,-67,-12,-56,81,-54,46,67,-57,-7,-83,-3,34,-43,-13,78,-67,29,76,28,15,-37,42,45,76,-82,-36,-77,33,-23,55,-95,84,-65,81,-31,56,17,-36,75,-68,-29,-28,98,-78,42,58,-66,11,-18,-22,-75,-33,8,-64,-23,38,-3,63,16,7,35,17,-8,34,-88,-3,-76,-81,-99,-36,57,-94,-79,-16,106,-49,88,35,87,78,-70,-49,55,54,-90,-21,71,55,28,-78,-21,-70,-33,108,-34,82,59,-85,-29,-87,-39,33,-91,-80,40,-80,6,-26,-32,54,-44,75,-64,-54,-43,20,74,-31,85,3,-48,65,-96,-90,65,58,-111,52,50,89,-83,117,54,72,-21,44,-39,20,35,-32,-57,-49,41,-65,-22,24,-38,-44,-47,-75,3,67,-73,-38,-54,-15,90,50,53,84,72,-92,69,-92,-108,45,-51,55,12,-12,-39,73,32,-39,-35,78,-82,-56,-1,-20,42,-106,-66,1,37,-45,-80,-7,-74,-90,-19,-25,-43,-52,-79,8,41,91,1,-6,-25,27,10,-41,-94,-11,-75,-8,40,-62,48,20,27,63,-7,-18,39,-10,-64,-89,-83,-36,33,-91,-75,67,94,-46,84,87,-19,-41,84,-16,-59,10,-94,-42,44,-111,-81,-4,10,81,-77,77,-10,-58,65,-32,34,9,53,89,35,21,2,0,-69,-44,-50,-72,36,4,-55,-81,46,-31,-79,41,-47,-57,-54,86,-26,-11,67,-49,-102,-26,-26,-72,-13,-35,-83,80,45,17,102,21,107,-8,-73,-6,-75,-104,47,-2,15,34,-89,-80,-47,81,5,31,-26,-23,78,8,74,23,42,32,86,34,-49,-117,16,-43,20,-39,68,-62,-89,34,-23,33,81,2,-89,44,40,-10,56,-50,-83,56,-49,26,41,-54,-32,-85,11,-25,55,25,61,-91,20,-45,25,-89,-8,-32,-7,3,49,-88,88,86,-30,-53,32,79,-73,11,66,62,18,-83,71,40,8,16,-34,-69,55,-90,-25,-13,-6,11,-41,-76,70,-114,-96,-34,41,8,61,12,5,72,73,21,-98,58,-72,-31,41,-51,70,-52,68,-34,-59,-11,28,30,-87,-85,2,-73,71,-43,-82,77,-39,-14,-20,-59,-24,30,80,70,-19,74,18,-6,-106,9,-87,-81,-49,-23,-45,75,-41,4,-40,-55,-120,30,57,55,74,43,-31,-114,-24,30,-81,-58,31,26,16,80,-95,-22,-58,35,-74,2,74,44,-110,26,24,3,29,52,42,33,56,-18,41,66,91,-84,47,17,-27,-17,-73,4,-62,-86,-107,55,71,-26,-85,80,78,-37,-28,-64,63,-51,72,-9,-77,-1,52,5,60,-25,-2,36,-104,9,45,20,-53,-57,95,-52,48,52,-83,-78,20,-80,46,47,-41,85,-45,-43,61,-3,67,-72,5,-34,63,62,32,51,-18,12,-91,-62,-113,27,56,-21,58,39,65,54,-121,-5,-87,37,-43,-24,85,44,54,-59,-79,3,63,-42,-42,-29,17,-19,-47,22,-28,83,37,-75,-65,89,-3,-19,-57,-64,-97,-88,-67,-43,-20,65,62,4,19,-41,52,-38,-1,87,47,62,-32,-86,-56,-2,-35,51,6,-13,-13,73,36,-83,24,39,30,54,100,3,-35,-40,-24,-68,-21,62,12,84,0,-70,24,-96,-101,3,31,-2,88,-67,25,-40,59,-49,-36,39,61,19,88,85,-49,7,7,-64,75,54,-69,102,-38,17,77,-75,-25,-6,-12,-99,-64,3,-35,-74,37,-77,41,-47,41,69,-77,73,-46,18,-66,39,-2,-49,-72,31,89,-71,-117,10,64,83,29,-21,-103,-22,-78,94,-14,57,-84,-29,11,-49,-13,-22,-60,-65,-46,-63,-85,-7,37,14,-99,35,41,82,3,-39,12,-63,43,-62,85,11,0,-40,66,43,-26,65,-30,56,27,77,-52,-4,4,-109,-64,-87,-26,82,-43,-1,34,67,-43,63,-36,-5,42,-51,88,-57,-49,-95,61,-77,73,-31,-48,-90,7,-7,94,87,-25,91,-106,102,-5,-36,100,36,59,25,62,-7,-54,-80,39,-9,28,-40,-55,49,63,-59,-32,13,51,47,10,64,-117,5,19,45,-22,-19,-79,-57,97,84,69,40,-86,-7,51,-74,100,44,-35,-94,-8,-53,49,80,-69,-42,72,6,55,81,18,-80,75,32,5,52,-34,43,-104,49,-26,97,-9,-67,-8,-35,30,-58,-21,-55,24,-17,19,-33,39,-2,81,76,-63,2,-10,58,-41,56,-82,-80,98,2,39,82,-36,59,48,49,-22,-103,-85,-64,77,-29,34,69,-78,-57,-75,-51,76,82,87,-52,-25,63,1,16,96,29,9,-10,-23,15,78,67,60,65,-64,-70,-2,20,18,85,28,61,76,-81,46,-48,67,80,-76,-71,-62,9,-18,93,-21,-28,95,70,59,-69,20,-44,-50,54,2,-10,49,-39,-49,-61,-73,86,54,-72,4,-61,-10,-39,10,-70,32,-58,103,43,-42,-28,37,56,20,-31,19,-19,56,56,63,90,45,1,108,18,84,64,-71,73,40,51,76,-68,73,4,45,-46,-19,-60,32,-50,-80,19,-16,101,-21,-36,100,91,14,-54,118,-54,47,47,-54,-41,-36,-15,-31,-62,-67,-66,45,-1,-44,66,85,-42,58,58,12,3,54,41,-102,29,67,-99,-86,-83,9,-47,-21,38,-66,38,36,-18,44,25,78,30,-46,-74,-19,49,69,-7,-27,26,8,34,-43,38,-34,-86,4,41,-46,75,101,-59,-53,-74,18,18,-12,-9,44,3,112,65,106,-43,-31,-38,8,36,-80,-3,57,-70,23,74,-57,25,65,101,113,-3,-29,-27,40,-20,-34,0,-40,-116,48,8,14,34,53,-115,50,-22,-27,-15,-45,-84,60,41,-37,-86,47,-77,-20,79,-46,69,-70,-35,-56,67,-48,44,94,105,-11,69,-23,23,-15,-96,23,-6,-76,51,32,65,0,-35,-58,31,36,-45,10,-10,98,34,-66,-20,-63,60,-50,-12,72,49,78,49,88,-35,19,64,-57,120,-1,-52,56,-11,-61,77,-51,-24,10,71,-63,-71,62,35,-35,3,47,64,1,-65,0,-14,-20,92,67,26,-38,17,76,-70,-45,72,-67,-10,-27,-36,2,-49,83,26,82,100,11,-1,-37,-82,33,-16,-2,97,-89,-57,-75,5,57,4,114,35,70,100,73,-76,67,21,-54,-15,-3,-29,3,25,79,89,48,11,-31,31,5,-78,-77,-6,64,-106,-26,49,-65,-41,-79,46,-64,-86,-16,-12,-58,-20,-42,10,-26,51,74,-27,19,-42,-26,-50,-10,-11,-44,7,-7,58,39,91,-71,-13,-39,87,-42,-81,4,29,68,74,47,52,-23,76,-37,9,-71,52,-24,6,81,-19,79,89,-103,-13,1,-39,-1,80,15,13,29,71,36,78,-58,105,14,30,68,-14,-51,60,44,-17,-48,-28,72,-2,-10,-59,2,-72,47,11,-80,-25,-9,-70,-82,-30,-47,48,3,-81,-85,33,1,50,-64,26,-15,-48,-71,5,-29,-97,-13,45,-6,-6,-72,20,17,17,76,36,50,-43,-61,83,84,-22,60,76,76,-54,6,-34,-56,74,-9,-24,70,25,-5,50,1,-18,52,79,0,60,20,-95,71,66,3,68,2,103,26,39,65,7,1,-64,-11,12,-38,-78,-68,78,35,64,100,107,-12,-78,-55,91,70,120,-28,36,45,2,-26,74,113,42,114,32,-111,90,-97,-75,31,15,98,86,-51,-87,10,88,-53,-34,34,-9,47,-34,33,46,-7,-64,-30,38,72,103,0,7,-59,-87,-91,-49,76,67,102,-106,42,40,26,-30,110,-4,5,-12,-9,-63,-80,67,79,-1,68,68,89,63,-86,57,77,9,16,-10,45,-21,-55,11,-60,-37,74,-102,16,58,-16,-1,-48,-46,39,-9,99,-24,-82,-3,-36,-40,27,-61,-16,71,-59,-86,-98,-33,-59,5,35,53,51,85,37,53,23,43,-2,-46,-35,-6,-92,0,33,4,70,34,102,-80,49,65,39,-40,48,35,-31,-31,-32,36,48,30,-61,79,-3,-22,-75,74,8,77,-2,-66,43,-9,-22,50,42,-6,-37,6,-93,60,19,26,44,20,-26,56,-10,-11,-20,85,41,-14,39,42,77,34,23,56,28,-94,-30,13,-10,-65,86,75,59,-57,-74,-17,-70,97,44,-48,-3,-4,-22,24,19,56,-103,-94,35,-26,-89,-2,-38,52,23,63,-72,-43,-88,-100,70,75,-49,-81,69,-35,74,38,-77,1,24,-16,72,-73,20,43,-13,52,-19,52,-27,-41,-20,37,-48,-20,21,38,-29,-61,54,-45,-97,-95,100,52,0,-2,-63,-80,56,-65,-22,-56,43,72,65,22,84,-52,93,33,64,-47,-2,-79,50,51,33,-17,61,-26,-28,6,-112,90,55,96,-10,99,-38,-19,-88,33,44,-27,-14,-72,83,58,32,43,22,45,-52,-52,-57,46,-57,-71,-28,72,-98,-59,53,94,-40,-47,-95,51,63,-36,-33,20,-47,-123,-73,42,19,-1,28,76,-11,-21,-64,-72,-52,43,44,-75,24,-46,6,49,-24,44,-38,76,-2,-16,-100,-9,-82,-6,88,-82,63,-93,-20,-40,47,-103,-17,64,-9,81,-38,-85,84,58,-27,-92,87,-42,44,-94,-92,52,-83,19,49,15,31,-63,11,-86,44,71,35,71,-86,6,87,86,28,-46,64,71,50,-7,-48,98,-7,81,11,48,13,-50,-12,69,27,-30,-100,40,-71,-71,16,-94,-14,-66,76,17,-47,47,-38,72,20,-70,-2,-42,-47,44,32,-21,-21,-62,12,-67,-22,8,106,79,-54,-4,-64,-28,-4,-30,41,30,-85,-71,49,-51,18,35,84,46,104,21,-31,-41,-86,-71,19,-52,-31,-68,-53,-23,-3,-1,-37,-83,-24,-85,-42,-29,86,36,90,65,-49,19,-92,13,88,-54,-22,-49,-83,60,-9,-69,-59,4,62,-42,87,34,12,-79,2,-51,-63,9,30,-36,11,-89,5,4,-69,-59,-62,-50,-52,-38,29,39,102,-29,67,14,-22,35,-24,-58,-51,-22,61,-14,57,111,-29,-18,53,69,45,-74,35,-105,-63,-78,-44,-46,63,28,-28,78,66,55,-31,1,-54,-32,50,-88,-62,-53,61,-6,57,-30,61,77,98,-8,-50,-37,-5,32,38,29,1,74,9,-32,6,-77,23,-91,-52,21,66,-54,79,60,-51,99,82,93,29,-71,-79,29,83,26,45,-67,-85,-13,42,-51,49,-92,91,11,-9,109,56,51,50,-47,-100,33,-73,-84,-42,-79,-61,82,-84,-24,-52,15,75,-61,-61,76,-67,-48,-86,43,-55,-10,-103,11,67,67,59,-12,-64,36,13,-41,-71,-30,-68,0,-24,-5,36,-88,-52,-77,18,42,-81,-73,-100,-77,-22,-30,-11,-18,84,55,57,98,8,-32,-75,-9,45,20,63,-60,-57,66,3,70,53,43,94,-59,23,28,-32,54,82,-87,28,56,83,-57,15,31,68,-22,-72,-45,55,-27,81,72,-8,-47,-61,49,-41,-31,-66,-76,-83,76,48,22,-56,-53,-93,88,28,-20,19,21,-81,-1,-11,-48,72,55,-64,-17,-56,38,32,-5,-45,40,-12,45,77,-69,-75,21,-101,-80,-58,60,56,-92,90,20,-100,51,30,-105,45,-28,5,79,72,-56,85,-78,-31,-4,6,77,32,81,68,7,54,-31,-63,-41,48,-22,-67,-48,91,42,-48,-86,8,10,55,-94,42,47,-59,19,-33,-108,15,13,88,-14,-10,-72,-12,74,18,-39,24,-20,-38,85,-35,-30,-85,-21,34,-112,93,-84,-20,-58,18,48,21,11,25,-31,-21,19,-20,2,-15,8,-55,-73,-54,-92,-51,41,81,-1,-55,73,54,61,-114,-56,55,43,7,0,-94,56,-2,-50,-55,-81,-38,76,-95,-75,-46,46,-10,-8,-14,23,83,-60,-9,-14,-72,56,23,-8,-41,36,54,0,69,28,-15,47,70,-77,-62,41,-64,3,9,96,-3,-65,63,3,-71,12,-105,-71,-24,19,70,-16,85,57,-19,-10,11,-57,-43,-4,-60,-74,-22,80,78,-74,61,14,-66,36,-24,27,22,-28,64,-84,-60,0,-7,66,-23,46,75,76,91,-71,-101,48,-65,-39,-49,39,55,2,73,8,71,86,-44,15,-28,24,-71,-61,-25,-105,-11,-51,-35,77,-62,65,-61,-13,29,9,-58,47,-6,18,20,34,-4,-34,-54,65,-97,-27,-52,69,-40,-64,-67,58,46,-43,86,61,-27,-38,-37,68,28,69,25,-2,-84,16,84,-8,34,34,61,66,94,0,-41,-60,-63,27,56,82,-13,-51,38,65,-39,-65,-66,40,-14,-20,-41,60,-56,-57,51,18,111,82,63,28,42,-103,41,-88,50,51,65,8,-84,-24,68,-91,9,18,-72,-58,67,30,-37,14,-58,-60,-53,-71,32,-50,-39,-103,39,48,67,-89,8,19,-39,117,-6,15,67,-41,-2,48,-2,1,75,54,-95,0,79,68,85,96,14,-53,9,-6,56,-49,-4,22,65,-39,-21,-23,27,-60,-10,-12,99,21,-49,-74,-35,73,67,2,52,-86,39,86,33,20,81,6,-93,61,68,47,-33,33,37,-29,55,59,43,21,53,-28,82,-68,7,21,24,-3,32,-54,20,63,11,-62,-46,21,-44,-82,-64,36,-58,-20,-76,-4,-32,34,69,21,-21,82,88,-48,26,-46,39,88,76,-10,30,25,-54,9,9,-45,-8,63,-58,51,60,10,-66,-31,12,91,-12,-6,15,-69,-11,-82,-9,24,-31,14,-60,17,68,78,94,3,-60,-25,-27,-28,77,-66,14,-33,-10,-66,-104,-69,-16,14,45,24,-79,-52,-14,48,49,-59,58,-57,-27,-65,33,-2,-73,-19,51,13,16,55,96,20,-59,18,-68,-44,61,48,10,35,4,-43,26,-5,34,-26,-93,73,52,-46,-35,16,42,79,38,61,-61,-61,-98,-79,86,-85,-32,52,-29,47,-37,-20,-23,73,-14,-38,39,118,7,112,-11,84,-12,-13,-60,-45,-89,59,-62,10,-54,42,82,-26,-54,-15,55,12,4,51,80,-3,38,20,-32,-54,83,-43,81,67,-59,105,31,-64,-11,31,70,-69,-100,59,-4,-60,-94,-53,-106,2,41,52,-43,-18,0,-73,-51,-67,-57,63,46,36,-80,78,-5,-10,-33,66,-34,68,-29,-2,-33,-63,-11,46,18,82,-32,95,91,-39,89,-3,-35,-49,33,-66,61,9,-33,19,-22,20,37,-42,69,44,78,-27,-14,-18,-67,71,21,-102,-90,-107,-17,-17,-11,-6,-78,-5,42,-57,-63,43,87,29,-68,67,-86,-92,20,-32,-60,-98,-63,-51,63,41,-49,-73,-51,44,5,63,-59,-43,23,-86,-83,117,126,-55,-84,-79,26,-25,103,-18,-53,-33,20,18,-7,9,64,1,-28,-75,47,70,76,-40,-47,15,-15,77,-10,70,76,0,-27,-68,38,-58,-56,59,-22,96,46,44,-44,-17,11,-31,-78,34,-39,-11,-29,37,-61,-54,-40,63,35,20,-2,-29,-71,50,-59,50,-32,-63,48,11,71,106,-48,16,20,-78,-75,84,10,10,-9,-57,5,-89,-63,-37,35,1,-3,2,81,88,31,11,84,13,-58,30,72,69,106,79,52,-64,-72,-96,-113,-41,89,127,-42,-87,-24,17,-41,-7,-98,-98,-11,-34,-42,-12,58,-83,28,84,-33,-51,37,-31,-56,-97,-11,20,8,56,71,-5,-49,84,38,53,66,-18,-99,-50,29,113,100,-79,71,33,-58,64,-52,-45,52,-69,32,-2,5,36,75,41,-36,36,77,-1,4,-81,-51,38,-3,-19,29,23,-4,-31,12,-4,17,-38,-2,-5,103,-69,-60,-72,-63,64,-75,50,45,-38,35,47,50,-106,-47,-53,-27,11,-27,18,91,40,52,31,42,89,-48,-6,-104,-57,8,-50,7,52,-6,18,-101,-75,-15,14,15,-58,10,48,59,32,29,-32,-24,19,32,49,24,103,-78,-10,6,52,10,33,-79,41,-116,37,-7,54,-60,47,63,-61,4,-24,63,-92,-65,-34,-42,49,-6,24,23,-71,77,41,28,-13,-17,-91,27,65,-49,78,25,-15,-34,-60,-83,2,33,-55,-60,32,-76,25,50,-39,56,-77,47,77,41,-40,75,22,-51,75,33,52,-41,21,44,81,-64,-32,-75,11,-26,79,40,64,75,-58,110,35,24,-36,-38,-21,-84,11,82,-57,-13,-28,2,-52,7,50,-45,-4,-72,17,-66,-91,-65,83,-69,77,71,-22,-77,40,-61,-7,-51,43,-74,74,-18,-81,-11,49,-80,20,23,-24,1,26,70,25,-98,8,40,23,23,56,12,-73,-6,-17,81,29,70,-89,13,35,24,3,40,-68,-27,-5,-53,-68,-59,105,24,-69,-20,-71,49,-83,-36,-20,-20,-65,-72,45,-82,42,6,72,-61,-85,-36,-95,35,10,-35,57,-91,10,-25,43,38,63,-106,-58,38,-1,23,-22,24,-13,57,60,-7,-5,17,-55,30,15,46,-60,29,74,-62,-84,-35,43,23,57,-9,50,-74,-68,28,47,59,21,20,94,21,30,5,68,6,75,-18,75,-36,-40,-53,76,27,-56,-34,7,-100,86,-29,69,13,82,-72,4,24,-42,61,-82,56,-48,-51,-104,-113,-31,68,-88,-86,34,-105,60,40,50,64,79,38,-75,-78,-27,-93,-3,59,-25,-64,-52,65,80,-61,-53,8,-63,-35,80,-15,44,54,-37,57,42,-101,19,-123,-51,30,-40,76,11,-38,1,104,-75,-23,97,-40,26,-34,-29,61,30,35,-102,-70,7,-115,-53,-54,85,-31,89,8,-85,9,2,33,10,67,-57,-3,-30,-111,-46,12,66,15,88,-18,26,38,-57,16,83,5,-77,62,-8,-6,75,-47,20,-78,51,15,29,-46,94,13,27,86,59,17,-30,84,-97,11,-37,-5,42,22,-20,-88,67,76,-47,-33,61,-14,45,-57,101,42,41,-65,-50,66,-72,-33,-105,-19,39,-67,-74,-79,9,73,16,34,70,42,30,-74,-67,52,-36,-6,3,-100,-95,-78,-95,38,51,82,22,63,67,-7,-92,-75,-44,72,23,-50,-52,-24,-55,-33,4,22,0,58,92,6,-58,-8,-32,4,12,-5,94,-33,40,68,-44,49,48,-59,22,24,56,72,85,-32,10,-22,86,94,82,0,-10,-38,-91,-94,47,-111,31,-41,-65,25,7,74,66,-4,-36,-39,36,64,70,23,-79,-64,-87,-8,67,53,-1,-22,-44,52,-25,5,22,23,81,101,13,10,-26,-49,-112,39,-37,26,39,70,11,-9,-84,59,24,5,35,3,-32,63,-41,41,-83,-12,-66,-32,-111,20,-31,-23,99,61,7,20,-29,55,10,-58,11,-55,79,-16,-7,8,-42,97,-43,125,74,2,115,30,-47,91,-11,41,18,108,108,-38,15,85,90,-52};
const int32_t fc_biases[] = {-677,665};
const int8_t conv_filter[] = {-71, 127, 82, -22, 60, -118, 29, -46, 87};
const int32_t conv_bias[] = { -2 };

int main( )    
{ 
  gpio = 0xFFFFFFFC; // turn off the LEDs  
  uint32_t threshold =20;    
  InitCAM(JPEG);
  clear_fifo_flag();
  write_reg(ARDUCHIP_FRAMES,0x00);
  set_Light_Mode(Office);
  set_Color_Saturation(Saturation0);  
  set_Brightness(Brightness0);
  set_Contrast(Contrast0);
  set_Special_effects(Normal);  
  set_JPEG_size(OV2640_320x240); 
  int8_t buf1[IMAGE_SIZE]; 
  int8_t buf2[IMAGE_SIZE];
  while(1){   
    capture(threshold);
    quantize(buf1);
    convolution2D(buf1,buf2); 
    maxPooling2D(buf2, buf1);
    fullyConnected(buf1, buf2);
    debug = ((int32_t)buf2[0])+128;
    debug = ((int32_t)buf2[1])+128;
    for (uint16_t row = 0; row < IMAGE_HEIGHT; row++){
      for (uint16_t col = 0; col < IMAGE_WIDTH; col++){
          debug = getFrameByte(row*IMAGE_WIDTH + col);
      } 
    }
    terminate(); 
  }
while(1); 
}    


void quantize(int8_t* output){
    for (uint8_t row = 0; row < IMAGE_HEIGHT; row++){
        for (uint8_t col = 0; col < IMAGE_WIDTH; col++){
            uint32_t index = row*IMAGE_WIDTH + col;
            uint32_t b = getFrameByte(index);
            int32_t b2 = b - 128;
            output[index] = (int8_t) b2;
        }
    }
}

void convolution2D(int8_t* input,int8_t* output) {
    for (int oy = 0; oy < CONV_OUTPUT_HEIGHT; oy++) {
        for (int ox = 0; ox < CONV_OUTPUT_WIDTH; ox++) {
            int32_t conv_result = conv_bias[0];
            int32_t one = 1;
            int32_t zero = 0;
            for (int fy = 0; fy < FILTER_HEIGHT; fy++) {
                for (int fx = 0; fx < FILTER_WIDTH; fx++) {
                    for (int c = 0; c < IMAGE_CHANNELS; c++) {
                        int iy = oy * CONV_STRIDE + fy;
                        int ix = ox * CONV_STRIDE + fx;
                        int8_t input_value = input[iy * (IMAGE_WIDTH * IMAGE_CHANNELS) + ix * IMAGE_CHANNELS + c];
                        int8_t filter_value = conv_filter[fy * (FILTER_WIDTH * FILTER_CHANNELS) + fx * FILTER_CHANNELS + c];
                        conv_result += (int32_t)input_value * (int32_t)filter_value;
                    }
                }
            }
            if (conv_result < 0) {
                conv_result = 0;
            } else if (conv_result > 127) {
                conv_result = 127;
            }
            output[oy * (CONV_OUTPUT_WIDTH * IMAGE_CHANNELS) + ox * IMAGE_CHANNELS] = (int8_t)conv_result;
        }
    }
}


void maxPooling2D(int8_t* input, int8_t* output) {
    for (int oy = 0; oy < POOL_OUTPUT_HEIGHT; oy++) {
        for (int ox = 0; ox < POOL_OUTPUT_WIDTH; ox++) {
            int8_t max_value = input[(oy * POOL_SIZE) * (CONV_OUTPUT_WIDTH * IMAGE_CHANNELS) + (ox * POOL_SIZE) * IMAGE_CHANNELS];
            for (int py = 0; py < POOL_SIZE; py++) {
                for (int px = 0; px < POOL_SIZE; px++) {
                    for (int c = 0; c < IMAGE_CHANNELS; c++) {
                        int iy = oy * POOL_SIZE + py;
                        int ix = ox * POOL_SIZE + px;
                        int8_t input_value = input[iy * (CONV_OUTPUT_WIDTH * IMAGE_CHANNELS) + ix * IMAGE_CHANNELS + c];
                        if (input_value > max_value) {
                            max_value = input_value;
                        }
                    }
                }
            }
            output[oy * (POOL_OUTPUT_WIDTH * IMAGE_CHANNELS) + ox * IMAGE_CHANNELS] = max_value;
        }
    }
}

void fullyConnected(int8_t* input, int8_t* output) {
    for (int o = 0; o < NUM_CLASSES; o++) {
        int32_t fc_result = fc_biases[o];
        int32_t one = 1;
        int32_t zero = 0;
        for (int i = 0; i < FC_PARAMETERS_PER_CLASS; i++) {
            int32_t input_value = input[i];
            int32_t weight_value = fc_weights[o * FC_PARAMETERS_PER_CLASS + i];
            fc_result += (int32_t)input_value * (int32_t)weight_value;
        }
        if (fc_result < -128) {
            fc_result = -128;
        } else if (fc_result > 127) {
            fc_result = 127;
        }
        output[o] = (int8_t)fc_result;
    }
}